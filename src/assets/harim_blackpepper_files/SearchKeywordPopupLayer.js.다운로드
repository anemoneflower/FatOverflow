define(["jquery","common/template/urlBuilder","common/utils/validationUtils","common/reporter/queryStringAppender","common/reporter/gaToWiseLogMaker","common/utils/cookieUtils","common/essentialData","search/searchWebLogSchemas","search/utils/weblogUtils-min"],function($,urlBuilder,validationUtils,queryStringAppender,gaToWiseLogMaker,cookie,essentialData,searchWebLogSchemas,weblogUtils){var TTI_DATA=[],MAX_TTI_LOGGING_SIZE=10;var LOG_PARAMS=searchWebLogSchemas.LOG_PARAMS||{};var SearchKeywordPopupLayer=
function(targetInfo){this.$searchForm=$(targetInfo.searchForm);this.$popupLayer=$(targetInfo.popupLayerElement);this.$inputTarget=$(targetInfo.inputTarget);this.$searchChannel=this.$searchForm.find("input[name\x3d'channel']");this.$subminBtn=$(targetInfo.submitBtn);this.preSearchKeyword="";this.onRequest=false;this.init()};SearchKeywordPopupLayer.prototype={init:function(){this.bindEvent()},bindEvent:function(){var _this=this;this.$popupLayer.on("mousedown keydown","[data-channel]",function(e){var $this=
$(this);if(cookie.getValue("search-history")!="OFF"){cookie.addCookie("searchKeyword",$this.data("searchkeyword"),"|",{timeValue:10});var searchKeywordType={};searchKeywordType[$this.data("searchkeyword")]=$this.data("travel")&1;cookie.addCookie("searchKeywordType",JSON.stringify(searchKeywordType),"|",{timeValue:10})}if(e.keyCode===13||e.keyCode===108)window.location.href=_this.buildSearchKeywordUrlWithChannel(encodeURIComponent($this.data("searchkeyword")),$this.data("channel"),$this.data("travel"))});
this.$popupLayer.on("mousedown","[data-channel]",function(e){var $this=$(this);if(cookie.getValue("search-history")!="OFF"){cookie.addCookie("searchKeyword",$this.data("searchkeyword"),"|",{timeValue:10});var searchKeywordType={};searchKeywordType[$this.data("searchkeyword")]=$this.data("travel")&1;cookie.addCookie("searchKeywordType",JSON.stringify(searchKeywordType),"|",{timeValue:10})}window.location.href=_this.buildSearchKeywordUrlWithChannel(encodeURIComponent($this.data("searchkeyword")),$this.data("channel"),
$this.data("travel"))});this.$popupLayer.on("mouseenter focusin","[data-channel]",function(e){$(this).addClass("sect")});this.$popupLayer.on("mouseleave focusout","[data-channel]",function(e){$(this).removeClass("sect")});this.firedSearchKeywordHistoryEvent()},upKeyButtonInPopupLayerEvent:function(){var keywordElements=this.$popupLayer.find("[data-channel]");var totalCount=keywordElements.length;if(totalCount<1)return;var selectedIndex=keywordElements.index(this.$popupLayer.find(".sect"));keywordElements.removeClass("sect");
if(selectedIndex<=0){this.$inputTarget.val(this.getPreSearchKeyword());this.$searchChannel.val("user")}else{var selectElement=keywordElements.eq(selectedIndex-1);selectElement.addClass("sect");this.$inputTarget.val(selectElement.data("searchkeyword"));this.$searchChannel.val(selectElement.data("channel"));this.$searchChannel.data("rank",selectedIndex+1);this.$searchChannel.data("prefix",this.getPreSearchKeyword())}},downKeyButtonInPopupLayerEvent:function(){var keywordElements=this.$popupLayer.find("[data-channel]");
var totalCount=keywordElements.length;if(totalCount<1)return;var selectedIndex=keywordElements.index(this.$popupLayer.find(".sect"));if(selectedIndex<totalCount-1){keywordElements.removeClass("sect");var selectElement=keywordElements.eq(selectedIndex+1);selectElement.addClass("sect");this.$inputTarget.val(selectElement.data("searchkeyword"));this.$searchChannel.val(selectElement.data("channel"));this.$searchChannel.data("rank",selectedIndex+1);this.$searchChannel.data("prefix",this.getPreSearchKeyword())}},
closePopupSearchKeyword:function(){this.onRequest=false;this.$popupLayer.hide();this.$popupLayer.next().hide()},setPreSearchKeyword:function(keyword){this.preSearchKeyword=keyword},getPreSearchKeyword:function(){return this.preSearchKeyword},renderingSearchKeywordHistory:function(){var _this=this;var $historyOnOffBtn=$(".history-onoff");var searchKeywords=cookie.getValue("searchKeyword");var searchKeywordTypes=cookie.getValue("searchKeywordType")?"["+cookie.getValue("searchKeywordType")+"]":"[]";
this.$popupLayer.removeClass("auto-search");if(cookie.getValue("search-history")=="OFF"){_this.$popupLayer.html(_this.buildSearchKeywordHistoryLayerOffHtml());$historyOnOffBtn.removeClass("on").addClass("off").text("최근검색어켜기");_this.$popupLayer.show();_this.$popupLayer.next().addClass("fixTop");_this.$popupLayer.next().show()}else if(!!searchKeywords){var keywordArr=searchKeywords.split("|");var keywordTypeArr=JSON.parse(searchKeywordTypes.replace(/\|/g,","));_this.$popupLayer.html(_this.buildSearchKeywordHistoryLayerHtml(keywordArr,
keywordTypeArr));$(".autocomplete_wrap ol li").eq(0).find("a").trigger("mouseenter");$historyOnOffBtn.removeClass("off").addClass("on").text("최근검색어끄기");_this.$popupLayer.show();_this.$popupLayer.next().removeClass("fixTop");_this.$popupLayer.next().show();_this.bindClickLogEventHandler()}else{_this.$popupLayer.hide();_this.$popupLayer.next().hide();_this.$popupLayer.html("")}},firedSearchKeywordHistoryEvent:function(){var _this=this;this.$popupLayer.on("mouseenter focusin",".delete-kwdhistory",function(e){e.preventDefault();
$(this).addClass("select-btn")});this.$popupLayer.on("mouseleave focusout",".delete-kwdhistory",function(e){e.preventDefault();$(this).removeClass("select-btn")});$(".search-form").on("click",".del-button",function(e){e.preventDefault();var $this=$(e.target);if($this.hasClass("delete-all-kwdhistory")){cookie.erase("searchKeyword");$("#headerPopupWords, .history-btns").hide()}else{cookie.substractCookie("searchKeyword",$this.data("searchkeyword"),"|",{timeValue:10});$this.parent().remove()}});$(".search-form").on("click",
".history-onoff",function(e){e.preventDefault();if($(e.currentTarget).hasClass("on")){cookie.setCookie("search-history","OFF",{timeUnit:"DAY",timeValue:365});_this.renderingSearchKeywordHistory()}else{cookie.setCookie("search-history","ON",{timeUnit:"DAY",timeValue:365});_this.renderingSearchKeywordHistory()}})},buildSearchKeywordHistoryLayerOffHtml:function(){var html='\x3cdiv class\x3d"autocomplete_wrap"\x3e\x3cspan class\x3d"history-off-msg"\x3e최근 검색어 저장 기능이 꺼져 있습니다.\x3c/span\x3e';html+="\x3c/div\x3e";
return html},buildSearchKeywordHistoryLayerHtml:function(keywordArr,keywordTypeArr){var _this=this;var MAX_KEYWORD_NUMBER=9;keywordArr.reverse();keywordTypeArr.reverse();var keywordLength=keywordArr.length>MAX_KEYWORD_NUMBER?MAX_KEYWORD_NUMBER:keywordArr.length;var listHtml='\x3cdiv class\x3d"autocomplete_wrap"\x3e\x3ch3\x3e\x3cspan\x3e최근\x3c/span\x3e 검색어\x3c/h3\x3e\x3col\x3e';for(var i=0;i<keywordLength;i++){var travelKeyword=_this.isTravelKeyword(keywordArr[i],keywordTypeArr);listHtml+='\x3cli\x3e\x3ca href\x3d"javascript:;" data-channel\x3d"recent" class\x3d"kwd"';
listHtml+=' data-searchkeyword\x3d"'+keywordArr[i]+'"';listHtml+=' data-travel\x3d"'+travelKeyword+'"';listHtml+=' data-coulog\x3d\'{"customURL": "/click_search_recent_keyword", "logCategory":"event", "logType":"click", "logLabel":"SRP", "q":"'+keywordArr[i]+"\"}'\x3e";listHtml+=keywordArr[i]+'\x3c/a\x3e\x3cspan data-searchkeyword\x3d"'+keywordArr[i]+'"class\x3d"delete-kwdhistory del-button"\x3e삭제\x3c/span\x3e\x3c/li\x3e'}listHtml+="\x3c/ol\x3e";listHtml+="\x3c/div\x3e";return listHtml},isTravelKeyword:function(keyword,
keywordTypeArr){for(var i=0;i<keywordTypeArr.length;i++)if(keywordTypeArr[i][keyword])return true;return false},renderingAutoCompleteSearchKeyword:function(){this.onRequest=true;var _this=this;var keyword=$.trim(this.$inputTarget.val());var startTime=(new Date).getTime();if(!keyword)return;$.ajax({url:urlBuilder.buildRequestUrl("/np/search/autoComplete"),data:{keyword:keyword},cache:false,dataType:"jsonp",jsonp:"callback",success:function(response){if(_this.onRequest==false)return;if(validationUtils.isNotEmpty(response)){var documentFragment=
$(document.createDocumentFragment());documentFragment.append(_this.buildAutoCompleteSearchKeywordPopupLayerHtml(response));_this.$popupLayer.html(documentFragment);_this.$popupLayer.show();_this.bindClickLogEventHandler();_this.updateTTIData((new Date).getTime()-startTime)}else{_this.$popupLayer.hide();_this.$popupLayer.html("")}},error:function(){_this.$popupLayer.hide();_this.$popupLayer.html("")}});$(".history-btns").hide();this.$popupLayer.addClass("auto-search")},buildAutoCompleteSearchKeywordPopupLayerHtml:function(keywords){var keyword=
this.$inputTarget.val();var MAX_KEYWORD_COUNT=11;var keywordLength=keywords.length>MAX_KEYWORD_COUNT?MAX_KEYWORD_COUNT:keywords.length;var listHtml='\x3cdiv class\x3d"autocomplete_wrap"\x3e';for(var i=0;i<keywordLength;i++)if(validationUtils.isNotEmpty($.trim(keywords[i]))){listHtml+='\x3ca href\x3d"javascript:;"';listHtml+=' data-channel\x3d"auto" data-searchkeyword\x3d"'+keywords[i].keyword+'"';listHtml+=' data-travel\x3d"'+keywords[i]["travelKeyword"]+'"';listHtml+=' data-requestid\x3d"'+keywords[i]["requestId"]+
'"';listHtml+=' data-coulog\x3d\'{"customURL": "/click_search_autocomplete_keyword", "logCategory":"event", "logType":"click", "logLabel":"SRP", "rank":"'+i+'", "prefix":"'+keyword+'", "q":"'+keywords[i].keyword+"\"}'\x3e";listHtml+=keywords[i].keyword.replace(keyword,"\x3cstrong\x3e"+keyword+"\x3c/strong\x3e")+"\x3c/a\x3e"}listHtml+="\x3c/div\x3e";return listHtml},buildSearchKeywordUrlWithChannel:function(keyword,channel,isTravelKeyword){var queryString="q\x3d"+keyword;var componentId=$("#searchCategories").children("option").filter(":selected").data("category-id");
if(validationUtils.isNotEmpty(channel))queryString+="\x26channel\x3d"+channel;if(validationUtils.isNotEmpty(componentId))queryString+="\x26component\x3d"+componentId;return(!componentId||componentId===90918)&&isTravelKeyword?queryStringAppender.getUrlWithQueryStringDelimiter(essentialData.getWebDomain()+"/np/travel/search/decision",queryString):queryStringAppender.getUrlWithQueryStringDelimiter(this.$searchForm.data("actionurl"),queryString)},updateTTIData:function(tti){TTI_DATA.push(tti);TTI_DATA.length>=
MAX_TTI_LOGGING_SIZE&&this.putTTILogger()},putTTILogger:function(){var sum=0;for(var i in TTI_DATA)sum+=parseFloat(TTI_DATA[i])||0;if(window["tti"]&&sum>0){window["tti"]["label"]="SRP_AUTOCOMPLETE";window["tti"]["getTTI"]=function(){return sum/MAX_TTI_LOGGING_SIZE};window["tti"]["logTTI"]&&window["tti"]["logTTI"]();TTI_DATA=[]}if(window.CoupangWebLog&&sum>0){var weblog={};$.extend(true,weblog,LOG_PARAMS.SRP_AUTOCOMPLETE_TTI);$.extend(weblog.data,{tti:Math.floor(sum/MAX_TTI_LOGGING_SIZE)});weblogUtils.sendLog(weblog);
TTI_DATA=[]}},bindClickLogEventHandler:function(){$(".autocomplete_wrap a").on("click",function(){var data=$(this).data()||{};var channel=data.channel;var logData=data.coulog;var requestId=data.requestid;if(!channel||!logData)return;var weblog={};if(channel==="auto"){$.extend(true,weblog,LOG_PARAMS.SRP_AUTOCOMPLETE_CLICK);$.extend(weblog.data,{prefix:logData.prefix,rank:parseInt(logData.rank)||0,q:logData.q,requestId:requestId})}else if(channel==="recent"){$.extend(true,weblog,LOG_PARAMS.SRP_HISTORY_CLICK);
$.extend(weblog.data,{q:logData.q})}else{$.extend(true,weblog,LOG_PARAMS.SRP_SEARCH_BUTTON_CLICK);$.extend(weblog.data,{q:logData.q})}weblogUtils.sendLog(weblog)})}};return SearchKeywordPopupLayer});